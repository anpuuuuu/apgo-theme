{% comment %}
  è³¼ç‰©è»Šé -æ¢ä»¶å¼å„ªæƒ å€å¡Š
  æª”æ¡ˆä½ç½®: sections/cart-conditional-offer.liquid
  ä¸»è¦åŠŸèƒ½: æ ¹æ“šè³¼ç‰©è»Šé‡‘é¡é¡¯ç¤ºä¸åŒçš„å„ªæƒ æ¢ä»¶
{% endcomment %}

<!-- å…§è¯é—œéµæ¨£å¼é˜²æ­¢é–ƒçˆ -->
<style>
  /* ç§»é™¤æ‰€æœ‰å¯èƒ½çš„å®¹å™¨èƒŒæ™¯è‰² */
  .shopify-section,
  .shopify-section[class*="cart-conditional"],
  [class*="shopify-section-template"][class*="cart_conditional"],
  .section-cart-conditional {
    background-color: transparent !important;
    background: transparent !important;
    background-image: none !important;
  }
  
  /* ç¢ºä¿ wrapper å®Œå…¨é€æ˜ */
  .conditional-offer-wrapper {
    background-color: transparent !important;
    background: transparent !important;
    background-image: none !important;
  }
  
  /* ç¢ºä¿åªæœ‰å…§éƒ¨å®¹å™¨æœ‰èƒŒæ™¯è‰² */
  .conditional-offer-section {
    background-color: {{ section.settings.loading_bg_color }} !important;
    min-height: 80px;
  }
</style>

<style>
  /* ========================================
     è³¼ç‰©è»Šæ¢ä»¶å¼å„ªæƒ å€å¡Š - æ‰‹æ©Ÿç‰ˆå„ªå…ˆè¨­è¨ˆ
     ======================================== */
  
  /* å¤–å±¤åŒ…è£å™¨ */
  .conditional-offer-wrapper {
    width: 100%;
    max-width: 800px;
    margin: 12px auto 0;
    padding: 0 16px;
    position: relative;
    background: transparent !important;
  }
  
  /* ä¸»å®¹å™¨ */
  .conditional-offer-section {
    background: linear-gradient(145deg, #2d2d2d, #1a1a1a) !important;
    border: 1px solid #404040 !important;
    border-radius: 10px;
    padding: 12px;
    position: relative;
    overflow: hidden;
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  }
  
  .conditional-offer-section:hover {
    border-color: #ff6b35 !important;
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(255, 107, 53, 0.2);
  }
  
  /* é ‚éƒ¨æ©˜è‰²ç·šæ¢ */
  .conditional-offer-section::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: {% if section.settings.use_accent_gradient %}
      linear-gradient(90deg, {{ section.settings.accent_color_start }}, {{ section.settings.accent_color_end }})
    {% else %}
      {{ section.settings.accent_color_start }}
    {% endif %} !important;
  }
  
  /* é€²åº¦æ¢å®¹å™¨ */
  .progress-container {
    margin-bottom: 12px;
  }
  
  /* é€²åº¦æ¢æ¨™é¡Œ */
  .progress-title {
    font-size: 13px;
    font-weight: 600;
    color: {{ section.settings.text_color }} !important;
    margin: 0 0 6px 0;
    display: flex;
    align-items: center;
    gap: 6px;
  }
  
  .progress-title::before {
    content: 'ğŸ¯';
    font-size: 14px;
  }
  
  /* é€²åº¦æ¢èƒŒæ™¯ */
  .progress-bar-bg {
    width: 100%;
    height: 6px;
    background: #333333 !important;
    border-radius: 3px;
    overflow: hidden;
    position: relative;
  }
  
  /* é€²åº¦æ¢å¡«å…… */
  .progress-bar-fill {
    height: 100%;
    background: {% if section.settings.use_accent_gradient %}
      linear-gradient(90deg, {{ section.settings.accent_color_start }}, {{ section.settings.accent_color_end }})
    {% else %}
      {{ section.settings.accent_color_start }}
    {% endif %} !important;
    border-radius: 4px;
    transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
    position: relative;
    overflow: hidden;
  }
  
  /* é€²åº¦æ¢å‹•ç•«æ•ˆæœ */
  .progress-bar-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
    animation: shimmer 2s infinite;
  }
  
  @keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
  }
  
  /* é€²åº¦æ–‡å­— */
  .progress-text {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-top: 6px;
    font-size: 11px;
    color: {{ section.settings.text_secondary_color }} !important;
  }
  
  .current-amount {
    font-weight: 600;
    color: {{ section.settings.accent_color_start }} !important;
  }
  
  .target-amount {
    font-weight: 500;
  }
  
  /* å„ªæƒ è¨Šæ¯å®¹å™¨ */
  .offer-message-container {
    margin-top: 8px;
  }
  
  /* å„ªæƒ è¨Šæ¯ */
  .offer-message {
    font-size: 12px;
    line-height: 1.3;
    color: {{ section.settings.text_color }} !important;
    margin: 0;
    padding: 8px 10px;
    border-radius: 6px;
    background: rgba(255, 107, 53, 0.1) !important;
    border: 1px solid rgba(255, 107, 53, 0.2) !important;
    position: relative;
    overflow: hidden;
  }
  
  .offer-message::before {
    content: 'ğŸ’¡';
    position: absolute;
    left: 10px;
    top: 50%;
    transform: translateY(-50%);
    font-size: 14px;
  }
  
  .offer-message .message-text {
    margin-left: 24px;
  }
  
  /* å·²é”æˆå„ªæƒ æ¨£å¼ */
  .offer-message.achieved {
    background: rgba(76, 175, 80, 0.1) !important;
    border-color: rgba(76, 175, 80, 0.3) !important;
  }
  
  .offer-message.achieved::before {
    content: 'ğŸ‰';
    font-size: 14px;
  }
  
  /* å„ªæƒ é‡‘é¡å¼·èª¿ */
  .offer-amount {
    font-weight: 700;
    color: {{ section.settings.accent_color_start }} !important;
    text-shadow: 0 0 8px rgba(255, 107, 53, 0.3);
  }
  
  /* è¼‰å…¥ç‹€æ…‹ */
  .conditional-offer-section.loading {
    min-height: 100px;
    position: relative;
  }
  
  .conditional-offer-section.loading::after {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 32px;
    height: 32px;
    border: 3px solid #333333 !important;
    border-top-color: #ff6b35 !important;
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  
  @keyframes spin {
    to { transform: translate(-50%, -50%) rotate(360deg); }
  }
  
  /* å¹³æ¿ç‰ˆæ¨£å¼ */
  @media (min-width: 768px) {
    .conditional-offer-wrapper {
      padding: 0 20px;
      margin: 16px auto 0;
    }
    
    .conditional-offer-section {
      padding: 16px;
      border-radius: 12px;
    }
    
    .progress-title {
      font-size: 14px;
    }
    
    .offer-message {
      font-size: 13px;
      padding: 12px;
    }
  }
  
  /* æ¡Œé¢ç‰ˆæ¨£å¼ */
  @media (min-width: 1024px) {
    .conditional-offer-section {
      padding: 18px;
    }
    
    .progress-title {
      font-size: 15px;
    }
    
    .offer-message {
      font-size: 14px;
      padding: 14px;
    }
  }
  
  /* éš±è—é¸é … */
  .conditional-offer-wrapper[data-hide-progress="true"] .progress-container {
    display: none;
  }
</style>

<!-- é‡è¦ï¼šåŠ ä¸Š ID ä»¥ä¾¿æ›¿æ›æ•´å€‹å€å¡Š -->
<div class="conditional-offer-wrapper" 
     id="conditional-offer-wrapper-{{ section.id }}"
     data-hide-progress="{{ section.settings.hide_progress }}">
  
  <div class="conditional-offer-section" id="conditional-offer-{{ section.id }}">
    
    <!-- é€²åº¦æ¢å€åŸŸ -->
    {% unless section.settings.hide_progress %}
    <div class="progress-container">
      <h4 class="progress-title">{{ section.settings.progress_title }}</h4>
      <div class="progress-bar-bg">
        <div class="progress-bar-fill" id="progress-fill-{{ section.id }}" style="width: 0%"></div>
      </div>
      <div class="progress-text">
        <span class="current-amount" id="current-amount-{{ section.id }}">NT$ 0</span>
        <span class="target-amount" id="target-amount-{{ section.id }}">NT$ {{ section.settings.target_amount }}</span>
      </div>
    </div>
    {% endunless %}
    
    <!-- å„ªæƒ è¨Šæ¯å€åŸŸ -->
    <div class="offer-message-container">
      <div class="offer-message" id="offer-message-{{ section.id }}">
        <div class="message-text">
          <span id="offer-text-{{ section.id }}">{{ section.settings.initial_message }}</span>
        </div>
      </div>
    </div>
    
  </div>
</div>

<script>
  // æ¢ä»¶å¼å„ªæƒ åŠŸèƒ½ - å¼·åŒ–ç‰ˆ
  class ConditionalOffer {
    constructor(sectionId, settings) {
      this.sectionId = sectionId;
      this.settings = settings;
      this.currentAmount = 0;
      this.targetAmount = parseFloat(settings.target_amount);
      this.wrapperId = `conditional-offer-wrapper-${sectionId}`;
      this.init();
    }
    
    init() {
      this.updateCartAmount();
      this.setupEventListeners();
    }
    
    // é›™é‡æ›´æ–°ç­–ç•¥ï¼šå…ˆæœ¬åœ°å¿«é€Ÿæ›´æ–°ï¼Œå†ä¼ºæœå™¨ç«¯ç²¾ç¢ºæ›´æ–°
    refreshAll() {
      this.updateCartAmount({ noStore: true });
      // å»¶é²åŸ·è¡Œ section renderï¼Œç¢ºä¿è³¼ç‰©è»Šå·²æ›´æ–°å®Œæˆ
      clearTimeout(this._srTimer);
      this._srTimer = setTimeout(() => this.refreshSectionFromServer(), 220);
    }
    
    updateCartAmount(opts = {}) {
      const fetchOpts = {
        method: 'GET',
        headers: { 'Accept': 'application/json' }
      };
      if (opts.noStore) fetchOpts.cache = 'no-store';
      
      // åŠ æ™‚é–“æˆ³é¿å…å¿«å–
      const url = `/cart.js?_=${Date.now()}`;
      fetch(url, fetchOpts)
        .then(r => r.json())
        .then(cart => {
          this.currentAmount = (cart.total_price || 0) / 100;
          this.updateDisplay();
        })
        .catch(err => console.error('ç„¡æ³•å–å¾—è³¼ç‰©è»Šè³‡æ–™:', err));
    }
    
    updateDisplay() {
      const progressFill = document.getElementById(`progress-fill-${this.sectionId}`);
      const currentAmountEl = document.getElementById(`current-amount-${this.sectionId}`);
      const offerMessage = document.getElementById(`offer-message-${this.sectionId}`);
      const offerText = document.getElementById(`offer-text-${this.sectionId}`);
      
      // é˜²å‘†è™•ç†ï¼šé¿å…é™¤ä»¥ 0
      const target = Number.isFinite(this.targetAmount) && this.targetAmount > 0 ? this.targetAmount : 1;
      const progress = Math.min((this.currentAmount / target) * 100, 100);
      
      if (progressFill) {
        progressFill.style.width = `${progress}%`;
      }
      
      if (currentAmountEl) {
        currentAmountEl.textContent = `NT$ ${this.currentAmount.toLocaleString()}`;
      }
      
      if (offerMessage && offerText) {
        if (this.currentAmount >= this.targetAmount) {
          // å·²é”æˆç›®æ¨™
          offerMessage.classList.add('achieved');
          const amt = Number(this.settings.discount_amount || 0);
          offerText.innerHTML = this.settings.achieved_message.replace(
            '{amount}',
            `<span class="offer-amount">NT$ ${amt.toLocaleString()}</span>`
          );
        } else {
          // æœªé”æˆç›®æ¨™
          offerMessage.classList.remove('achieved');
          const remainingRaw = Math.max(this.targetAmount - this.currentAmount, 0);
          const msg = this.settings.progress_message.replace(
            '{remaining}',
            `<span class="offer-amount">NT$ ${remainingRaw.toLocaleString()}</span>`
          );
          offerText.innerHTML = msg;
        }
      }
    }
    
    // ä½¿ç”¨ Section Rendering API å¾ä¼ºæœå™¨å–å¾—æœ€æ–° HTML
    refreshSectionFromServer() {
      const wrapper = document.getElementById(this.wrapperId);
      if (!wrapper) return;
      
      const url = `${window.location.pathname}?sections={{ section.id }}&_=${Date.now()}`;
      fetch(url, {
        method: 'GET',
        headers: { 'X-Requested-With': 'XMLHttpRequest' },
        cache: 'no-store'
      })
        .then(r => r.json())
        .then(payload => {
          const html = payload['{{ section.id }}'];
          if (!html) return;
          
          const temp = document.createElement('div');
          temp.innerHTML = html.trim();
          
          // å–å¾—æ–°å€å¡Šçš„ wrapper
          const newWrapper = temp.querySelector(`#${this.wrapperId}`);
          if (!newWrapper) return;
          
          // æ›¿æ›æ•´å€‹å€å¡Š
          wrapper.replaceWith(newWrapper);
          
          // é‡è¦ï¼šæ›¿æ›å¾Œé‡æ–°åˆå§‹åŒ–
          const sectionEl = document.getElementById(`conditional-offer-{{ section.id }}`);
          if (sectionEl) {
            new ConditionalOffer('{{ section.id }}', {
              target_amount: {{ section.settings.target_amount }},
              discount_amount: {{ section.settings.discount_amount }},
              initial_message: `{{ section.settings.initial_message | escape }}`,
              progress_message: `{{ section.settings.progress_message | escape }}`,
              achieved_message: `{{ section.settings.achieved_message | escape }}`
            });
          }
        })
        .catch(err => console.error('Section render å¤±æ•—:', err));
    }
    
    setupEventListeners() {
      // é˜²æŠ–è™•ç†
      const debounce = (fn, wait = 250) => {
        let t;
        return (...args) => {
          clearTimeout(t);
          t = setTimeout(() => fn.apply(this, args), wait);
        };
      };
      const debouncedRefresh = debounce(() => this.refreshAll(), 250);
      
      // ç›£è½æ‰€æœ‰å¯èƒ½çš„è³¼ç‰©è»Šæ›´æ–°äº‹ä»¶
      const EVENT_NAMES = [
        'cart:refresh',
        'cart:updated',
        'cart:update',
        'cart:change',
        'product:added',
        'ajaxProduct:added',
        'cart:request:complete',
        'theme:cart:update',
        'CartUpdateEvent'
      ];
      
      // ä¸‰å€‹ç›®æ¨™éƒ½ç›£è½ï¼Œç¢ºä¿æ¥æ”¶åˆ°æ‰€æœ‰äº‹ä»¶
      const targets = [document, document.documentElement, window];
      targets.forEach(target => {
        EVENT_NAMES.forEach(name => {
          target.addEventListener(name, debouncedRefresh, { passive: true });
        });
        // é¡åˆ¥å‹äº‹ä»¶ä¹Ÿç›£è½
        target.addEventListener('CartUpdateEvent', debouncedRefresh, { passive: true });
      });
      
      // Dawn ç­‰ä¸»é¡Œçš„ section è¼‰å…¥äº‹ä»¶
      document.addEventListener('shopify:section:load', (e) => {
        try {
          if (e?.detail?.sectionId === '{{ section.id }}') {
            this.refreshAll();
          }
        } catch(_) {}
      });
      
      // MutationObserver å‚™æ´ï¼šç›£è¦–è³¼ç‰©è»Š DOM è®ŠåŒ–
      try {
        const observerTargets = [
          document.querySelector('.cart-drawer__footer'),
          document.querySelector('#cart, .cart-items, cart-drawer-component')
        ].filter(Boolean);
        
        if (observerTargets.length) {
          const mo = new MutationObserver(() => {
            setTimeout(() => this.refreshAll(), 120);
          });
          observerTargets.forEach(t => {
            mo.observe(t, { childList: true, subtree: true });
          });
        }
      } catch(_) {}
      
      // è·¨åˆ†é åŒæ­¥
      window.addEventListener('storage', (e) => {
        if (e.key === 'cart-updated') debouncedRefresh();
      });
    }
  }
  
  // åˆå§‹åŒ–æ¢ä»¶å¼å„ªæƒ 
  document.addEventListener('DOMContentLoaded', function() {
    const section = document.getElementById('conditional-offer-{{ section.id }}');
    if (section) {
      new ConditionalOffer('{{ section.id }}', {
        target_amount: {{ section.settings.target_amount }},
        discount_amount: {{ section.settings.discount_amount }},
        initial_message: `{{ section.settings.initial_message | escape }}`,
        progress_message: `{{ section.settings.progress_message | escape }}`,
        achieved_message: `{{ section.settings.achieved_message | escape }}`
      });
    }
  });
</script>

{% schema %}
{
  "name": "è³¼ç‰©è»Šé -æ¢ä»¶å¼å„ªæƒ å€å¡Š",
  "class": "section-cart-conditional",
  "tag": "section",
  "settings": [
    {
      "type": "header",
      "content": "åŸºæœ¬è¨­å®š"
    },
    {
      "type": "text",
      "id": "progress_title",
      "label": "é€²åº¦æ¢æ¨™é¡Œ",
      "default": "è·é›¢å…é‹è²»é‚„å·®"
    },
    {
      "type": "number",
      "id": "target_amount",
      "label": "ç›®æ¨™é‡‘é¡",
      "default": 1500,
      "info": "é”åˆ°æ­¤é‡‘é¡å³å¯äº«å—å„ªæƒ "
    },
    {
      "type": "number",
      "id": "discount_amount",
      "label": "å„ªæƒ é‡‘é¡",
      "default": 100,
      "info": "é”åˆ°ç›®æ¨™å¾Œå¯äº«å—çš„å„ªæƒ é‡‘é¡"
    },
    {
      "type": "header",
      "content": "è¨Šæ¯è¨­å®š"
    },
    {
      "type": "textarea",
      "id": "initial_message",
      "label": "åˆå§‹è¨Šæ¯",
      "default": "å†è²·ä¸€é»å°±èƒ½äº«å—å„ªæƒ ï¼",
      "info": "ä½¿ç”¨ {amount} ä¾†é¡¯ç¤ºå„ªæƒ é‡‘é¡"
    },
    {
      "type": "textarea",
      "id": "progress_message",
      "label": "é€²åº¦è¨Šæ¯",
      "default": "å†è²· {remaining} å³å¯äº«å—å„ªæƒ ï¼",
      "info": "ä½¿ç”¨ {remaining} ä¾†é¡¯ç¤ºå‰©é¤˜é‡‘é¡"
    },
    {
      "type": "textarea",
      "id": "achieved_message",
      "label": "é”æˆè¨Šæ¯",
      "default": "æ­å–œï¼æ‚¨å·²ç²å¾— {amount} å„ªæƒ ï¼",
      "info": "ä½¿ç”¨ {amount} ä¾†é¡¯ç¤ºå„ªæƒ é‡‘é¡"
    },
    {
      "type": "header",
      "content": "é¡¯ç¤ºè¨­å®š"
    },
    {
      "type": "checkbox",
      "id": "hide_progress",
      "label": "éš±è—é€²åº¦æ¢",
      "default": false,
      "info": "åªé¡¯ç¤ºå„ªæƒ è¨Šæ¯ï¼Œä¸é¡¯ç¤ºé€²åº¦æ¢"
    },
    {
      "type": "header",
      "content": "é¡è‰²è¨­å®š"
    },
    {
      "type": "color",
      "id": "loading_bg_color",
      "label": "è¼‰å…¥èƒŒæ™¯è‰²",
      "default": "#1a1a1a",
      "info": "é˜²æ­¢è¼‰å…¥æ™‚ç™½è‰²é–ƒçˆçš„é è¨­èƒŒæ™¯è‰²"
    },
    {
      "type": "checkbox",
      "id": "use_accent_gradient",
      "label": "ä½¿ç”¨å¼·èª¿è‰²æ¼¸è®Š",
      "default": true
    },
    {
      "type": "color",
      "id": "accent_color_start",
      "label": "å¼·èª¿è‰²ï¼ˆèµ·å§‹ï¼‰",
      "default": "#ff6b35"
    },
    {
      "type": "color",
      "id": "accent_color_end",
      "label": "å¼·èª¿è‰²ï¼ˆçµæŸï¼‰",
      "default": "#f7931e"
    },
    {
      "type": "color",
      "id": "text_color",
      "label": "ä¸»è¦æ–‡å­—é¡è‰²",
      "default": "#ffffff"
    },
    {
      "type": "color",
      "id": "text_secondary_color",
      "label": "æ¬¡è¦æ–‡å­—é¡è‰²",
      "default": "#cccccc"
    }
  ],
  "presets": [
    {
      "name": "è³¼ç‰©è»Šæ¢ä»¶å¼å„ªæƒ ",
      "category": "éŠ·å”®åŠŸèƒ½"
    }
  ]
}
{% endschema %}