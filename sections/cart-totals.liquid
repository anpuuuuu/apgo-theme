{%- comment -%} Cart Totals (standalone section) {%- endcomment -%}
<div
  id="CartTotals-{{ section.id }}"
  class="cart-totals cart-totals--standalone color-{{ section.settings.color_scheme }}"
  data-section-id="{{ section.id }}"
  data-section-type="cart-totals"
  data-content-id="CartTotalsContent-{{ section.id }}"
  data-init-flag="__cartTotalsInit_{{ section.id }}"
>
  <!-- ğŸ‘‰ åªæ›¿æ›é€™å€‹å…§å®¹å€ï¼Œå¤–å±¤ wrapper ä¸å‹• -->
  <div id="CartTotalsContent-{{ section.id }}">
    {%- liquid
      if settings.currency_code_enabled_cart_total
        assign total_price_formatted = cart.total_price | money_with_currency
      else
        assign total_price_formatted = cart.total_price | money
      endif
    -%}

    {%- if section.settings.show_note_or_code -%}
      {%- if settings.show_cart_note or settings.show_add_discount_code -%}
        <div class="cart-totals__actions">
          {%- if settings.show_cart_note -%}
            {% render 'cart-note' %}
          {%- endif -%}
          {%- if settings.show_add_discount_code -%}
            {% render 'cart-discount', section_id: section.id %}
          {%- endif -%}
        </div>
      {%- endif -%}
    {%- endif -%}

    <div class="cart__total-container">
      <!-- å°è¨ˆ -->
      <div class="cart__summary-item cart__original-total">
        <span class="cart__label">{{ 'content.cart_subtotal' | t }}</span>
        <span class="cart__value">{{ cart.original_total_price | money }}</span>
      </div>

      <!-- æŠ˜æ‰£æ¸…å–® -->
      {%- if cart.cart_level_discount_applications.size > 0 -%}
        {%- for discount in cart.cart_level_discount_applications -%}
          <div class="cart__summary-item cart__discount">
            <span class="cart__label">
              {{- 'icon-discount.svg' | inline_asset_content -}}
              {{ discount.title | escape }}
            </span>
            <span class="cart__value">-{{ discount.total_allocated_amount | money }}</span>
          </div>
        {%- endfor -%}
      {%- endif -%}

      <!-- ç¸½è¨ˆ -->
      <div class="cart__summary-item cart__total" role="status">
        <span class="cart__label">{{ 'content.cart_estimated_total' | t }}</span>
        <text-component
          ref="cartTotalStandalone"
          value="{{ total_price_formatted | strip_html }}"
          class="cart__value cart__value--highlight"
          data-cart-subtotal
        >
          {{ total_price_formatted }}
        </text-component>
      </div>

      <!-- åˆ†æœŸä»˜æ¬¾ -->
      {%- if section.settings.show_installments and settings.show_installments -%}
        <div class="cart__summary-item cart__installments">
          {% form 'cart', cart %}{{ form | payment_terms }}{% endform %}
        </div>
      {%- endif -%}

      <!-- ç¨…å‹™è³‡è¨Š -->
      <div class="cart__summary-item cart__tax cart__tax-notice-stack">
        {% render 'tax-info', has_discounts_enabled: settings.show_add_discount_code %}
        <small class="cart__checkout-redirect-notice">{{ 'content.checkout_redirect_notice' | t }}</small>
      </div>
    </div>
  </div>
</div>
  
  {% stylesheet %}
  /* ========================================
     è³¼ç‰©è»Šç¸½è¨ˆå€å¡Šæ¨£å¼è¨­è¨ˆ - åƒ…é‡å°ç¨ç«‹å€å¡Š
     ======================================== */
  
  /* ä¸»å®¹å™¨æ¨£å¼ - ä½¿ç”¨ç‰¹å®šé¡åˆ¥é¿å…è¡çª */
  .cart-totals--standalone { 
    display: flex; 
    flex-direction: column; 
    gap: var(--gap-md); 
    background: transparent !important;
    border-radius: 0 !important;
    box-shadow: none !important;
    border: none !important;
    padding: 0 !important;
    margin: 20px auto !important;
    max-width: 480px !important;
    width: 100% !important;
    position: relative !important;
    z-index: 1 !important;
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, 'Noto Sans', sans-serif !important;
    color: #ffffff !important;
  }
  
  /* ç§»é™¤æ©˜è‰²é ‚éƒ¨ç·šæ¢ */
  .cart-totals--standalone::before {
    display: none !important;
  }
  
  /* æ¯ä¸€æ¢å°±æ˜¯å·¦å³å…©å´ */
  .cart-totals--standalone .cart__summary-item {
    display: flex !important;
    justify-content: space-between !important; /* å·¦å³å…©ç«¯å°é½Š */
    align-items: center !important;
    padding: 8px 0 !important;
    font-size: 14px !important;
    border: none !important; /* é è¨­ä¸è¦åº•ç·š */
  }

  /* å°è¨ˆ */
  .cart-totals--standalone .cart__original-total .cart__label {
    color: #ccc !important;
  }
  .cart-totals--standalone .cart__original-total .cart__value {
    color: #fff !important;
    font-weight: 600 !important;
  }

  /* æŠ˜æ‰£ */
  .cart-totals--standalone .cart__discount .cart__label {
    display: flex !important;               /* è®“ icon èˆ‡æ–‡å­—åœ¨åŒä¸€è¡Œ */
    align-items: center !important;
    gap: 4px !important;                    /* icon èˆ‡æ–‡å­—çš„è·é›¢ */
    color: #ff6b35 !important;
    font-weight: 500 !important;
  }
  .cart-totals--standalone .cart__discount .cart__value {
    color: #ff6b35 !important;
    font-weight: 500 !important;
  }
  
  /* æ“ä½œå€å¡Š */
  .cart-totals--standalone .cart-totals__actions {
    display: flex !important;
    flex-direction: column !important;
    gap: var(--gap-2xs) !important;
    border-top: 1px solid #333333 !important;
    border-bottom: 1px solid #333333 !important;
    padding: 20px 0 !important;
    margin: 0 0 24px 0 !important;
  }
  
  /* ç¸½è¨ˆå®¹å™¨ */
  .cart-totals--standalone .cart__total-container {
    background: linear-gradient(135deg, #2a1810, #1a1a1a) !important;
    border: 1px solid #ff6b35 !important;
    border-radius: 12px !important;
    padding: 20px !important;
    position: relative !important;
    overflow: hidden !important;
    margin: 0 0 24px 0 !important;
  }
  
  .cart-totals--standalone .cart__total-container::before {
    content: '' !important;
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    right: 0 !important;
    height: 3px !important;
    background: linear-gradient(90deg, #ff6b35, #f7931e) !important;
  }
  
  /* ç¸½è¨ˆ */
  .cart-totals--standalone .cart__total {
    margin-top: 8px !important;
    padding-top: 12px !important;
    border-top: 2px solid #ff6b35 !important;
  }
  .cart-totals--standalone .cart__total .cart__label {
    font-size: 16px !important;
    font-weight: 700 !important;
    color: #ff6b35 !important;
  }
  .cart-totals--standalone .cart__value--highlight {
    font-size: 18px !important;
    font-weight: 700 !important;
    background: linear-gradient(135deg, #ff6b35, #f7931e) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
  }

  /* åˆ†æœŸä»˜æ¬¾ã€ç¨…å‹™è³‡è¨Š */
  .cart-totals--standalone .cart__installments,
  .cart-totals--standalone .cart__tax {
    font-size: 12px !important;
    color: #aaa !important;
    padding-top: 6px !important;
  }

  /* ç¨…å‹™èªªæ˜èˆ‡çµå¸³è·³è½‰æç¤ºï¼šä¸Šä¸‹æ’åˆ—ã€å­—é«”ä¸€è‡´ */
  .cart-totals--standalone .cart__tax-notice-stack {
    flex-direction: column !important;
    align-items: flex-start !important;
  }

  /* èˆ‡ tax-info çš„ <small> å®Œå…¨ä¸€è‡´ */
  .cart-totals--standalone .cart__tax-notice-stack .cart__checkout-redirect-notice {
    display: block !important;
    margin-top: 6px !important;
  }
  
  /* éŸ¿æ‡‰å¼è¨­è¨ˆ */
  @media (max-width: 768px) {
    .cart-totals--standalone {
      margin: 12px auto !important;
      border-radius: 0 !important;
      padding: 0 !important;
      width: calc(100% - 24px) !important;
      max-width: calc(100% - 24px) !important;
    }
    
    .cart-totals--standalone .cart__original-total-label {
      font-size: 15px !important;
    }
    
    .cart-totals--standalone .cart__original-total-value {
      font-size: 16px !important;
    }
    
    .cart-totals--standalone .cart__total-label {
      font-size: 16px !important;
    }
    
    .cart-totals--standalone .cart__total-value {
      font-size: 18px !important;
    }
  }
  
  @media (max-width: 480px) {
    .cart-totals--standalone {
      padding: 0 !important;
      margin: 8px auto !important;
    }
    
    .cart-totals--standalone .cart__original-total-label {
      font-size: 14px !important;
    }
    
    .cart-totals--standalone .cart__original-total-value {
      font-size: 15px !important;
    }
    
    .cart-totals--standalone .cart__total-label {
      font-size: 15px !important;
    }
    
    .cart-totals--standalone .cart__total-value {
      font-size: 17px !important;
    }
  }
  
  /* å‹•ç•«æ•ˆæœ */
  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
  
  .cart-totals--standalone {
    animation: fadeInUp 0.6s ease-out !important;
    animation-delay: 0.1s !important;
    animation-fill-mode: both !important;
  }
  
  /* ç§»é™¤ç™¼å…‰æ•ˆæœ */
  .cart-totals--standalone:hover {
    box-shadow: none !important;
  }
  {% endstylesheet %}
  
  {% javascript %}
  (function() {
    const wrapper = document.querySelector('[data-section-type="cart-totals"]');
    if (!wrapper) return;

    // é˜²æ­¢é‡è¤‡åˆå§‹åŒ–
    const FLAG = wrapper.dataset.initFlag;
    if (window[FLAG]) return;
    window[FLAG] = true;

    const sid = wrapper.dataset.sectionId;
    const contentId = wrapper.dataset.contentId;

    // å°å·¥å…·ï¼šæ¯æ¬¡éƒ½å–æœ€æ–°çš„ content å®¹å™¨
    const getContentEl = () => document.getElementById(contentId);

    // å»æŠ–ï¼šæŠŠé »ç¹çš„äº‹ä»¶åˆä½µ
    let tmr;
    const debounce = (fn, delay = 180) => {
      clearTimeout(tmr);
      tmr = setTimeout(fn, delay);
    };

    // ç”¨ routes.root æ”¯æ´å¤šèªç³»/å­è·¯å¾‘
    const root = (window.Shopify && Shopify.routes && Shopify.routes.root) ? Shopify.routes.root : '/';

    function htmlToNode(html) {
      const dom = new DOMParser().parseFromString(html, 'text/html');
      return dom.getElementById(contentId);
    }

    function refreshTotals() {
      // å…ˆè©¦æ–°ç‰ˆ ?sections=
      const u1 = new URL(window.location.href);
      u1.pathname = root.replace(/\/$/, '') + u1.pathname.replace(root.replace(/\/$/, ''), '');
      u1.searchParams.set('sections', sid);

      fetch(u1.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
        .then(r => r.ok ? r.json() : Promise.reject())
        .then(json => {
          const html = json && json[sid];
          if (!html) throw new Error('Sections JSON missing');
          const freshContent = htmlToNode(html);
          const contentEl = getContentEl();
          if (freshContent && contentEl) {
            contentEl.replaceWith(freshContent);
          }
        })
        .catch(() => {
          // èˆŠæ³• fallback: ?section_id=
          const u2 = new URL(window.location.href);
          u2.pathname = root.replace(/\/$/, '') + u2.pathname.replace(root.replace(/\/$/, ''), '');
          u2.searchParams.set('section_id', sid);

          fetch(u2.toString(), { headers: { 'X-Requested-With': 'XMLHttpRequest' } })
            .then(r => r.text())
            .then(html => {
              const freshContent = htmlToNode(html);
              const contentEl = getContentEl();
              if (freshContent && contentEl) {
                contentEl.replaceWith(freshContent);
              }
            })
            .catch(() => {
              console.error('Failed to refresh totals');
            });
        });
    }

    // â€”â€” A: ä¸»é¡Œ/å¤–æ›å¯èƒ½ä¸Ÿçš„äº‹ä»¶ â€”â€” //
    [
      'cart:updated','cart:change','cart:refresh','quantity:change',
      'product:added','cart:item:added','cart:item:updated','cart:item:removed'
    ].forEach(evt => document.addEventListener(evt, () => debounce(() => refreshTotals(), 240)));

    // â€”â€” B: æ””æˆª cart ç›¸é—œçš„ fetch / XHR â€”â€” //
    const _fetch = window.fetch;
    window.fetch = function(...args){
      return _fetch.apply(this, args).then(res => {
        try {
          const u = String(args[0]||'');
          if (u.includes('/cart') || u.includes('/add') || u.includes('cart/add')) {
            debounce(() => refreshTotals(), 260);
          }
        } catch(e){}
        return res;
      });
    };

    const _open = XMLHttpRequest.prototype.open;
    XMLHttpRequest.prototype.open = function(m, u, ...rest) {
      this.addEventListener('load', function(){
        try {
          const s = String(u||'');
          if (s.includes('/cart') || s.includes('/add') || s.includes('cart/add')) {
            debounce(() => refreshTotals(), 260);
          }
        } catch(e){}
      });
      return _open.apply(this, [m, u, ...rest]);
    };

    // â€”â€” C: é¡åƒåŸç”Ÿ summaryï¼ˆä½ æ˜¯éš±è—ä¸æ˜¯ç§»é™¤ï¼‰ â€”â€” //
    const nativeTotal = document.querySelector(
      '.cart-page__summary [data-cart-subtotal], .cart-page__summary .cart__total .cart__total-value'
    );
    if (nativeTotal) {
      const sync = () => {
        const mine = document.querySelector('#' + contentId + ' [data-cart-subtotal]');
        if (!mine) return;
        const t = (nativeTotal.textContent||'').trim();
        if (t && t !== (mine.textContent||'').trim()) {
          mine.textContent = t;
          mine.setAttribute('value', t);
        }
      };
      const mo = new MutationObserver(sync);
      mo.observe(nativeTotal, { characterData:true, childList:true, subtree:true });
      sync();
    }

    // åˆå§‹åŒ–å…ˆè·‘ä¸€æ¬¡ï¼ˆçµ¦é¦–æ¬¡é€²é æˆ–å¿«å–ï¼‰
    document.addEventListener('DOMContentLoaded', () => refreshTotals());
  })();
  {% endjavascript %}
  
  {% schema %}
  {
    "name": "Cart Totals (Standalone)",
    "settings": [
      { "type": "checkbox", "id": "show_note_or_code", "label": "Show cart note / discount code (uses theme settings)", "default": true },
      { "type": "checkbox", "id": "show_installments", "label": "Show installments (uses theme settings)", "default": true },
      { "type": "color_scheme", "id": "color_scheme", "label": "Color scheme", "default": "scheme-3" }
    ],
    "blocks": [],
    "presets": [{ "name": "Cart Totals (Standalone)"}]
  }
  {% endschema %}